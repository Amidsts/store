{"version":3,"file":"verifyOtp.js","sourceRoot":"src/","sources":["components/Auth/controllers/verifyOtp.ts"],"names":[],"mappings":";;;;;;;;;;;;;;AAKA,sDAEiC;AACjC,6DAAoC;AACpC,+DAAsC;AAEtC,SAAe,SAAS,CAAC,GAAa,EAAE,GAAa;;QACnD,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,UAAU,EAAE,GAAoC,GAAG,CAAC,IAAI,CAAC;QAE9E,IAAI,CAAC;YACH,MAAM,SAAS,GAAG,MAAM,oBAAS,CAAC,OAAO,CAAC,EAAE,KAAK,EAAE,CAAC,CAAA;YACpD,IAAI,CAAC,SAAS,EAAE,CAAC;gBACf,OAAO,IAAA,0BAAe,EAAC;oBACrB,GAAG;oBACH,OAAO,EAAE,yDAAyD;oBAClE,MAAM,EAAE,GAAG;iBACZ,CAAC,CAAC;YACL,CAAC;YAED,MAAM,QAAQ,GAAG,MAAM,mBAAQ,CAAC,OAAO,CAAC;gBACtC,IAAI,EAAE,SAAS,CAAC,GAAG;gBACnB,IAAI;gBACJ,OAAO,EAAE,UAAU;aACpB,CAAC,CAAA;YACF,IAAI,CAAC,QAAQ,EAAE,CAAC;gBACd,OAAO,IAAA,0BAAe,EAAC;oBACrB,GAAG;oBACH,OAAO,EAAE,2BAA2B;oBACpC,MAAM,EAAE,GAAG;iBACZ,CAAC,CAAC;YACL,CAAC;YAED,MAAM,GAAG,GAAG,IAAI,IAAI,EAAE,CAAC;YAEvB,IAAI,GAAG,GAAG,QAAQ,CAAC,QAAQ,EAAE,CAAC;gBAC5B,OAAO,IAAA,0BAAe,EAAC;oBACrB,GAAG;oBACH,OAAO,EAAE,iBAAiB;oBAC1B,MAAM,EAAE,GAAG;iBACZ,CAAC,CAAC;YACL,CAAC;YAED,QAAQ,CAAC,UAAU,GAAG,IAAI,CAAC;YAC3B,QAAQ,CAAC,QAAQ,GAAG,GAAG,CAAC;YACxB,MAAM,QAAQ,CAAC,IAAI,EAAE,CAAC;YAEtB,OAAO,IAAA,0BAAe,EAAC;gBACrB,GAAG;gBACH,OAAO,EAAE,4DAA4D;aACtE,CAAC,CAAC;QACL,CAAC;QAAC,OAAO,GAAG,EAAE,CAAC;YACb,IAAA,0BAAe,EAAC;gBACd,GAAG;gBACH,GAAG;gBACH,OAAO,EAAE,2BAA2B,GAAG,CAAC,OAAO,EAAE;gBACjD,MAAM,EAAE,GAAG;aACZ,CAAC,CAAC;QACL,CAAC;IACH,CAAC;CAAA;AAED,kBAAe,SAAS,CAAC","sourcesContent":["import { Response } from \"express\";\nimport { z } from \"zod\";\n\nimport { IRequest } from \"../../../utils/types\";\nimport { verifyOtpSchema } from \"../auth.validators\";\nimport {\n  responseHandler\n} from \"../../../utils/response\";\nimport OtpModel from \"../otp.model\";\nimport AuthModel from \"../auth.model\";\n\nasync function verifyOtp(req: IRequest, res: Response) {\n  const { code, email, otpPurpose }: z.infer<typeof verifyOtpSchema> = req.body;\n\n  try {\n    const userExist = await AuthModel.findOne({ email })\n    if (!userExist) {\n      return responseHandler({\n        res,\n        message: \"There was a problem at this time, pls wait some minutes\",\n        status: 404,\n      });\n    }\n\n    const otpExist = await OtpModel.findOne({\n      User: userExist._id,\n      code,\n      purpose: otpPurpose,\n    })\n    if (!otpExist) {\n      return responseHandler({\n        res,\n        message: \"invalid verification code\",\n        status: 404,\n      });\n    }\n\n    const now = new Date();\n\n    if (now > otpExist.expireAt) {\n      return responseHandler({\n        res,\n        message: \"OTP has expired\",\n        status: 400,\n      });\n    }\n\n    otpExist.isVerified = true;\n    otpExist.expireAt = now;\n    await otpExist.save();\n\n    return responseHandler({\n      res,\n      message: \"otp verification completed, proceed to reset your password\",\n    });\n  } catch (err) {\n    responseHandler({\n      res,\n      err,\n      message: `Internal Server Error:  ${err.message}`,\n      status: 500,\n    });\n  }\n}\n\nexport default verifyOtp;\n"]}