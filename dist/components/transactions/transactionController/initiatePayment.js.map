{"version":3,"file":"initiatePayment.js","sourceRoot":"src/","sources":["components/transactions/transactionController/initiatePayment.ts"],"names":[],"mappings":"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","sourcesContent":["import { Response } from \"express\";\nimport { z } from \"zod\";\nimport Currency from \"currency.js\";\n\nimport { initiatePaymentSchema } from \"../transaction.validators\";\nimport { responseHandler } from \"../../../utils/response\";\nimport { IRequest } from \"../../../utils/types\";\nimport ProductModel from \"../../Products/product.model\";\nimport axios from \"axios\";\nimport appConfig from \"../../../configs\";\nimport TxModel from \"../transaction.model\";\n\nasync function initiatePayment(req: IRequest, res: Response) {\n  const { paystackSecret } = appConfig;\n  const { user } = req;\n\n  const {\n    idempotencyKey,\n    productId,\n    currency,\n    quantity,\n  }: z.infer<typeof initiatePaymentSchema> = req.body;\n\n  try {\n    const product = await ProductModel.findById(productId);\n    if (!product)\n      return responseHandler({\n        res,\n        message: \"product not found\",\n        status: 404,\n      });\n\n    if (product.User === user._id)\n      return responseHandler({\n        res,\n        message: \"you can not buy your own product\",\n        status: 400,\n      });\n\n    if (product.quantityInStock < 1 || quantity > product.quantityInStock)\n      return responseHandler({\n        res,\n        message: \"product is out of stock or quantity is too high\",\n        status: 400,\n      });\n\n    const paymentExists = await TxModel.findOne({\n      Product: productId,\n      idempotencyKey,\n      status: \"successful\",\n    });\n    if (paymentExists)\n      return responseHandler({\n        res,\n        message: \"This payment has already been completed\",\n        status: 400,\n      });\n\n    const amount = Currency(product.price).multiply(quantity).value;\n\n    const customerExists = await axios.get(\n      `https://api.paystack.co/customer/${user.email}`,\n      {\n        headers: {\n          Authorization: `Bearer ${paystackSecret}`,\n        },\n      }\n    );\n\n    if (!customerExists) {\n      const customer = await axios.post(\n        \"https://api.paystack.co/customer\",\n        {\n          email: user.email,\n          first_name: user.firstName,\n          last_name: user.lastName,\n          phone: user.phoneNo,\n        },\n        {\n          headers: {\n            Authorization: `Bearer ${paystackSecret}`,\n            \"Content-Type\": \"application/json\",\n          },\n        }\n      );\n    }\n\n    const payload = {\n      email: user.email,\n      amount: `${amount}00`,\n      currency,\n    };\n\n    const { data } = await axios.post(\n      \"https://api.paystack.co/transaction/initialize\",\n      payload,\n      {\n        headers: {\n          Authorization: `Bearer ${paystackSecret}`,\n          \"Content-Type\": \"application/json\",\n        },\n      }\n    );\n\n    if (data.status) {\n      await new TxModel({\n        Buyer: user._id,\n        Supplier: product.User,\n        idempotencyKey,\n        Product: productId,\n        unitPrice: product.price,\n        totalPrice: amount,\n        status: \"pending\",\n        currency,\n        quantity,\n        paymentReference: data.data.reference,\n        paymentLink: data.data.authorization_url,\n      }).save();\n    }\n\n    return responseHandler({\n      res,\n      message: \"successful\",\n      data,\n    });\n  } catch (err) {\n    responseHandler({\n      res,\n      err,\n      message: `Internal Server Error:  ${err.message}`,\n      status: 500,\n    });\n  }\n}\n\nexport default initiatePayment;\n"]}